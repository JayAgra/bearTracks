<!DOCTYPE html>
<html lang="en">
<head>
    <title>Blackjack - 766 Scouting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#121212" id="themeMeta">
    <link rel="apple-touch-startup-image" href="public/launch.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scouting">
    <link rel="manifest" href="/app.webmanifest"/>
    <link rel="stylesheet" href="float.min.css" type="text/css">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="form.min.js"></script>
    <style>
        a,a:visited {
            text-align: center;
            text-decoration: none;
            font-size: 6vh;
            border-top: rgba(35,35,35,0);
            border-left: rgba(35,35,35,0);
            border-right: rgba(35,35,35,0);
            border-bottom: #fff;
            border-style: dotted;
            border-width: 0.25vh;
        }
        a:hover,a:active {
            color: #fff;
        }
        body {
            text-align: center;
        }
        table {
            border-collapse:separate;
            border: solid var(--gameFlairColor) 1px;
            border-radius: 6px;
        }

        td, th {
            border-left: solid var(--gameFlairColor) 1px;
            border-top: solid var(--inputColorSelected) 1px;
        }

        th {
            background-color: var(--transparent);
            color: var(--textColor);
            border-top: none;
            border-bottom: solid var(--gameFlairColor) 1px;
        }

        td:first-child, th:first-child {
            border-left: none;
        }

        canvas {
            background-color: #121212;
            image-rendering: crisp-edges;
        }
    </style>
</head>

<body id="body" class="dark-mode">
    <script>themeHandle()</script>
    <div class="container" id="search" style="display: flex;"> 
        <div>
            <h1 id="title" style="font-family: 'raleway-300'">766 Casino<br><span class="gametitle">Single-Player Blackjack</span></h1>
            <canvas id="bjCanvas" width="128" height="128" style="display: none;"></canvas><br>
            <button id="playBtn" type="button" style="color: #000; background-color: #FFB600; border-radius: 0.5rem;; border-style: solid; border-color: #FFB600; border-width: 0.875rem;; margin-top: 1rem;" onclick="startBlackjack()">Play</button><br><button id="backBtn" type="button" style="color: #68C3E2; background-color: #121212; border-radius: 0.5rem;; border-style: solid; border-color: #121212; border-width: 0.875rem;; margin-top: 1rem;" onclick="goToHome()">Back</button>
            </fieldset>
        </div>
    </div>
    <script>
        var cvs = document.getElementById("bjCanvas")
        var ctx = document.getElementById("bjCanvas").getContext("2d"); 
        window.allCardValues = 0;
        window.disableBtns = false;
        window.allCards = [];
        window.playerCards = [];
        window.casinoSecToken = "";
        window.dealerTotal = 0;
        //var allCards = [];
        //helper function to get mouse positions
        function getMousePos(canvas, event) {
            var rect = canvas.getBoundingClientRect();
            return {
                x: (event.clientX - rect.left)/2,
                y: (event.clientY - rect.top)/2
            };
        }

        //helper function to check whether a point is inside a rectangle
        function isInside(pos, rect) {
            return pos.x > rect.x && pos.x < rect.x+rect.width && pos.y < rect.y+rect.height && pos.y > rect.y
        }

        async function getInitialDraw() {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `/api/casino/blackjack/startingCards`, true);
            xhr.withCredentials = true;

            xhr.onreadystatechange = () => {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                console.log("200 ok")
                console.log(JSON.parse(xhr.responseText))
                return JSON.parse(xhr.responseText)
            } else if (xhr.status === 401) {
                console.log("401 failure")
            } else if (xhr.status === 400) {
                console.log("400 failure")
            } else if (xhr.status === 500) {
                console.log("500 failure")
            } else {
                console.log("awaiting response")
            }
            }

            xhr.send()
        }

        const waitMs = ms => new Promise(res => setTimeout(res, ms));

        async function checkForLoss(cardTotal, card) {
            if (cardTotal == 21) {
                window.disableBtns = true;
                const newPlayerCard = new Image()
                newPlayerCard.onload = function(){ctx.drawImage(this, (cvs.width/8) + (cvs.width/8)*(window.playerCards.length - 1), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2)}
                newPlayerCard.src = card;

                await waitMs(2000)

                var audio = new Audio('assets/yummy.mp3');
                audio.play();

                document.getElementById("bjCanvas").style.display = "none"
                document.getElementById("title").style.display = "inline";
                document.getElementById("playBtn").style.display = "inline";
                document.getElementById("backBtn").style.display = "inline";
                document.getElementById("bjCanvas").insertAdjacentHTML("afterend", `<h3 id="gameResult" style="font-family: 'raleway-300'" style="color: var(--gameFlairColor)">Blackjack!</h3>`)
                document.getElementById("playBtn").onclick = function(){window.location.reload();};

                const xhr = new XMLHttpRequest();
                xhr.open("GET", `/api/casino/blackjack/${cardTotal}/${window.casinoSecToken}/wonViaBlackjack`, true);
                xhr.withCredentials = true;

                xhr.onreadystatechange = async () => {
                if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                    console.log("200 good")
                } else if (xhr.status === 401) {
                    console.log("401 failure")
                } else if (xhr.status === 400) {
                    console.log("400 failure")
                } else if (xhr.status === 500) {
                    console.log("500 failure")
                } else {
                    console.log("awaiting response")
                }
                }
                xhr.send() 
            } else if (cardTotal > 21) {
                window.disableBtns = true;
                const newPlayerCard = new Image()
                newPlayerCard.onload = function(){ctx.drawImage(this, (cvs.width/8) + (cvs.width/8)*(window.playerCards.length - 1), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2)}
                newPlayerCard.src = card;

                await waitMs(2000)

                document.getElementById("bjCanvas").style.display = "none"
                document.getElementById("title").style.display = "inline";
                document.getElementById("playBtn").style.display = "inline";
                document.getElementById("backBtn").style.display = "inline";
                document.getElementById("bjCanvas").insertAdjacentHTML("afterend", `<h3 id="gameResult" style="font-family: 'raleway-300'" style="color: var(--gameFlairColor)">Bust!</h3>`)
                document.getElementById("playBtn").onclick = function(){window.location.reload();};
            } else {
                return;
            }
        }

        async function getNewCard() {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `/api/casino/blackjack/newCard`, true);
            xhr.withCredentials = true;

            xhr.onreadystatechange = async () => {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                const APINewCard = await JSON.parse(JSON.parse(xhr.responseText))
                console.log(APINewCard)
                console.log(APINewCard.card)
                window.allCards.push(APINewCard.card)
                window.playerCards.push(APINewCard.card)
                await checkForLoss(window.allCardValues + APINewCard.cardValue, APINewCard.card)
                window.allCardValues = window.allCardValues + APINewCard.cardValue;
                ctx.globalCompositeOperation = 'source-over';
                var newCardForPlayer = new Image()
                newCardForPlayer.onload = function(){ctx.drawImage(this, (cvs.width/8) + (cvs.width/8)*(window.playerCards.length - 1), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2)}
                newCardForPlayer.src = window.playerCards[window.playerCards.length - 1];
                return APINewCard.card;
            } else if (xhr.status === 401) {
                console.log("401 failure")
                return "401";
            } else if (xhr.status === 400) {
                console.log("400 failure")
                return "400";
            } else if (xhr.status === 500) {
                console.log("500 failure")
                return "500";
            } else {
                console.log("awaiting response")
            }
            }

            xhr.send()
        }

        function startBlackjack() {
        if (window.innerHeight < window.innerWidth) {
            alert("play in portrait mode, on a phone.")
        } else {
            window.allCardValues = 0;
            window.allCards = [];

            /*if (cvs.requestFullScreen) {
                cvs.requestFullScreen();
            } else if (cvs.webkitRequestFullScreen) {
                cvs.webkitRequestFullScreen();
            } else if (cvs.mozRequestFullScreen) {
                cvs.mozRequestFullScreen();
            }*/
            
            //Scale canvas
            cvs.style.width = (window.innerWidth) + "px"
            cvs.style.height = (window.innerHeight) + "px"
            cvs.width = window.innerWidth/2
            cvs.height = window.innerHeight/2

            //Hide all but canvas
            cvs.style.display = "inline";
            document.body.style.overflow = "hidden";
            document.getElementById("title").style.display = "none";
            document.getElementById("playBtn").style.display = "none";
            document.getElementById("backBtn").style.display = "none";
            try {document.getElementById("gameResult").remove()} catch(error){}

            //Clear canvas
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = "#121212";
            ctx.fillRect(0, 0, cvs.width, cvs.height);

            //Disable image smoothing
            ctx.imageSmoothingEnabled = false;
            ctx.webkitImageSmoothingEnabled = false;

            const cardBack = new Image();
            //const dealerHandCard = new Image();
            //const playerCard = new Image();

            ctx.globalCompositeOperation = 'source-over';
            //dealerHandCard.onload = function(){ctx.drawImage(this, (cvs.width/26), 0, cvs.width/2, cvs.width/2);}
            cardBack.onload = function(){
                //Dealer hand
                ctx.drawImage(this, (cvs.width/8), 0, cvs.width/2.5, cvs.width/2);
                ctx.drawImage(this, (cvs.width/8) + (cvs.width/8), 0, cvs.width/2, cvs.width/2);
                //Player hand
                ctx.drawImage(this, (cvs.width/8), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2);
                ctx.drawImage(this, (cvs.width/8) + (cvs.width/8), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2);
            };
            //Player hand
            //playerCard.onload = function(){ctx.drawImage(this, (cvs.width/20), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2);}

            //playerCard.src = "assets/player.png";
            //dealerHandCard.src = "assets/dealerhand.png";
            cardBack.src = "assets/card_back.png";

            //buttons
            const dealButton = {
                x: (cvs.width/2 - cvs.width/6) - cvs.width/14,
                y: (cvs.height/8)*7,
                width: cvs.width/6,
                height: cvs.width/6
            };

            const hitButton = {
                x: cvs.width/2 - cvs.width/14,
                y: (cvs.height/8)*7,
                width: cvs.width/6,
                height: cvs.width/6
            };

            const standButton = {
                x: (cvs.width/2 + cvs.width/6) - cvs.width/14,
                y: (cvs.height/8)*7,
                width: cvs.width/6,
                height: cvs.width/6
            };

            const dealBtn = new Image();
            const hitBtn = new Image();
            const standBtn = new Image();

            ctx.globalCompositeOperation = 'source-over';
            dealBtn.onload = function(){ctx.drawImage(this, dealButton.x, dealButton.y, dealButton.width, dealButton.height);}
            hitBtn.onload = function(){ctx.drawImage(this, hitButton.x, hitButton.y, hitButton.width, hitButton.height);}
            standBtn.onload = function(){ctx.drawImage(this, standButton.x, standButton.y, standButton.width, standButton.height);}
            
            dealBtn.src = "assets/deal.png";
            hitBtn.src = "assets/hit.png";
            standBtn.src = "assets/deal.png";

            //gameVars
            var dealt = false;
            window.playerCards = ["assets/card_back.png", "assets/card_back.png"];
            var drawnCards = ["assets/card_back.png", "assets/card_back.png"];
                cvs.addEventListener('click', async function(evt) {
                    var mousePos = getMousePos(cvs, evt);
                    if (window.disableBtns) {
                        console.log("buttons are disabled")
                    } else {
                    if (isInside(getMousePos(cvs, evt), dealButton)) {
                        console.log('deal button')
                        if (dealt) {
                            console.log("Already dealt");
                        } else {
                            const xhr = new XMLHttpRequest();
                            xhr.open("GET", `/api/casino/blackjack/startingCards`, true);
                            xhr.withCredentials = true;

                            xhr.onreadystatechange = async () => {
                            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                                console.log("200 ok");

                                ctx.globalCompositeOperation = 'destination-over';
                                ctx.fillStyle = "#121212";
                                ctx.fillRect(0, 0, cvs.width, cvs.height);

                                const APIFirstCards = JSON.parse(JSON.parse(xhr.responseText));
                                console.log(APIFirstCards);

                                ctx.globalCompositeOperation = 'source-over';
                                window.playerCards = [APIFirstCards.player0, APIFirstCards.player1];
                                drawnCards = [APIFirstCards.dealt, "assets/card_back.png"];
                                window.allCards.push(APIFirstCards.player0, APIFirstCards.player1, APIFirstCards.dealt);

                                const firstDrawnCard = new Image();
                                firstDrawnCard.onload = function(){
                                    ctx.drawImage(cardBack, (cvs.width/8), 0, cvs.width/2.5, cvs.width/2);
                                    ctx.drawImage(this, (cvs.width/8) + (cvs.width/8), 0, cvs.width/2, cvs.width/2);
                                }
                                firstDrawnCard.src = APIFirstCards.dealt;

                                const secondPlayerCard = new Image();
                                secondPlayerCard.onload = function(){
                                    ctx.drawImage(this, (cvs.width/8) + (cvs.width/8), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2);
                                }
                                secondPlayerCard.src = APIFirstCards.player1;

                                const firstPlayerCard = new Image();
                                firstPlayerCard.onload = function(){
                                    ctx.drawImage(this, (cvs.width/8), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2);
                                }
                                firstPlayerCard.src = APIFirstCards.player0;

                                ctx.drawImage(hitBtn, hitButton.x, hitButton.y, hitButton.width, hitButton.height);
                                ctx.drawImage(standBtn, standButton.x, standButton.y, standButton.width, standButton.height);

                                //ctx.drawImage(dealerHandCard, (cvs.width/26), 0, cvs.width/2, cvs.width/2)
                                //ctx.drawImage(playerCard, (cvs.width/20), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2);

                                window.allCardValues = Number(APIFirstCards.playerTotal);
                                console.log(APIFirstCards.playerTotal)

                                window.casinoSecToken = APIFirstCards.casinoToken
                                window.dealerTotal = APIFirstCards.dealerTotal

                                dealt = true;
                            } else if (xhr.status === 401) {
                                console.log("401 failure")
                            } else if (xhr.status === 400) {
                                console.log("400 failure")
                            } else if (xhr.status === 500) {
                                console.log("500 failure")
                            } else {
                                console.log("awaiting response")
                            }
                            }

                            xhr.send()              
                            }
                    } else if (isInside(getMousePos(cvs, evt), hitButton)) {
                        console.log('hit button');
                        if (dealt) {
                            await getNewCard().then(card => async function(){/*
                                ctx.globalCompositeOperation = 'source-over';
                                var newCardForPlayer = new Image()
                                newCardForPlayer.onload = function(){ctx.drawImage(this, (cvs.width/8) + (cvs.width/8)*(window.playerCards.length - 1), (cvs.width/2)*1.25, cvs.width/2, cvs.width/2)}
                                newCardForPlayer.src = window.playerCards[window.playerCards.length - 1];
                            */}).catch()
                        } else {
                            console.log("not yet dealt")
                        }
                    } else if (isInside(getMousePos(cvs, evt), standButton)) {
                        console.log('stand button');
                        if (dealt) {
                            window.disableBtns = true;
                            const xhr = new XMLHttpRequest();
                            xhr.open("GET", `/api/casino/blackjack/stand/${window.casinoSecToken}/${window.allCardValues}/${window.dealerTotal}`, true);
                            xhr.withCredentials = true;

                            xhr.onreadystatechange = async () => {
                            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                                const APINewCard = await JSON.parse(JSON.parse(xhr.responseText))
                                if (APINewCard.result == "win") {
                                    var audio = new Audio('assets/yummy.mp3');
                                    audio.play();
                                    document.getElementById("bjCanvas").style.display = "none"
                                    document.getElementById("title").style.display = "inline";
                                    document.getElementById("playBtn").style.display = "inline";
                                    document.getElementById("backBtn").style.display = "inline";
                                    document.getElementById("bjCanvas").insertAdjacentHTML("afterend", `<h3 id="gameResult" style="font-family: 'raleway-300'" style="color: var(--gameFlairColor)">Win!</h3>`)
                                    document.getElementById("playBtn").onclick = function(){window.location.reload();};
                                } else if (APINewCard.result == "loss") {
                                    document.getElementById("bjCanvas").style.display = "none"
                                    document.getElementById("title").style.display = "inline";
                                    document.getElementById("playBtn").style.display = "inline";
                                    document.getElementById("backBtn").style.display = "inline";
                                    document.getElementById("bjCanvas").insertAdjacentHTML("afterend", `<h3 id="gameResult" style="font-family: 'raleway-300'" style="color: var(--gameFlairColor)">Loss!</h3>`)
                                    document.getElementById("playBtn").onclick = function(){window.location.reload();};
                                }
                            } else if (xhr.status === 401) {
                                console.log("401 failure")
                                return "401";
                            } else if (xhr.status === 400) {
                                console.log("400 failure")
                                return "400";
                            } else if (xhr.status === 500) {
                                console.log("500 failure")
                                return "500";
                            } else {
                                console.log("awaiting response")
                            }
                            }

                            xhr.send()
                        } else {
                            console.log("not yet dealt")
                        }
                    }
                    }
                }, false);
            }
        }
    </script>
</body>
</html>